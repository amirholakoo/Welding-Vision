## **شرح دقیق سیستم**

### **۱. بخش مکانیکی**

1. **R: نگهدارنده و چرخاننده لوله (Pipe Rotator)**

   * دو مرغک با فیکسچر مستحکم برای نگه داشتن لوله‌ها (حدود ۳۰ کیلوگرم هر کدام).  
   * **موتور R** (مثلاً NEMA 23/موتور DC ) برای چرخاندن لوله با یک تسمه یا گیربکس.  
   * انکودر **E6A2** برای خواندن سرعت چرخش و زاویه دقیق.

2. **X, Y: مجموعه مشعل جوش**

   * **موتور استپر X**: وظیفه دارد مشعل جوشکاری را در راستای افقی **(چپ و راست)** حرکت دهد.  
     * انکودر **E6A2** برای خواندن سرعت حرکت و دقت.  
   * **موتور استپر Y**: وظیفهٔ تنظیم ارتفاع مشعل جوشکاری را دارد.  
     * دریافت داده از سنسور **VL53L0X** و حفظ فاصله ثابت (مثلاً 1.5 میلی‌متر).  
     * انکودر **E6A2** برای خواندن سرعت حرکت و دقت.

3. **F: تغذیه سیم جوش (Filler Feed)**

   * **موتور استپر F** با قابلیت تعیین سرعت توسط آردوینو (یا فرمان مستقیم از رزبری‌پای).  
     * انکودر **E6A2** برای خواندن سرعت حرکت.

---

### **۲. بخش الکترونیکی و کنترل**

1. **کنترلر اصلی**

   * **Raspberry Pi (مثلاً مدل ۵)**: مسئول پردازش تصویر، بینایی ماشین، و منطق تصمیم‌گیری سطح بالا.  
   * **Arduino Mega**: کنترل دقیق موتورها، دریافت و ارسال لحظه‌ای فیدبک سنسورها (انکودرها و VL53L0X).

2. **درایور موتور**

   * استفاده از شیلد CNC و درایورهای **A4988** (یا درایورهای سازگار) برای موتورهای استپر R, X, Y, F.  
   * تنظیم محدودکنندهٔ جریان برای جلوگیری از داغ شدن موتور یا از دست رفتن گام‌ها.

3. **دوربین و نورپردازی**

   * **ماژول دوربین رزبری‌پای (دوربین V3)** یا مشابه.  
   * نور LED کافی یا رینگ لایت جهت حذف سایه و بازتاب‌های مزاحم روی فلز؟

4. **منبع تغذیه**

   * **۲۴** ولت یا ۱۲ ولت **DC**  برای موتورهای استپر.  
   * **۵** ولت **تنظیم‌شده** برای رزبری‌پای و سنسورها.

5. **سنسورها و ماژول‌های فرعی**

   * انکودر **E6A2** برای محور R,X ,Y.  
   * سنسور فاصله **VL53L0X** برای محور Y.  
   * ماژول لیزر برای راهنمای جوشکاری.  
   * رله برای روشن/خاموش کردن تورچ جوش.  
   * رله برای روشن/خاموش کردن Emg STOP.

---

### **۳. بخش نرم‌افزار و جریان داده (Data Flow)**

1. **نرم‌افزار آردوینو مگا**

   * **حلقهٔ اجرا نقشه‌برداری و تصمیم‌گیری Accept/Reject Job:**  
     * دریافت فرمان از رزبری‌پای  
   * **حلقهٔ اصلی جوشکاری:**  
     * دریافت عرض شکاف بر حسب میلی‌متر	  
     * فید پیوسته با سرعت پایه: اگر شکاف زیاد شود (اما هنوز ≤۶ میلی‌متر)، سرعت افزایش می‌یابد.  
     * انجام حرکت رفت‌وبرگشتی ±۴۰۰ گام با سرعت تنظیم‌شده (مثلاً ۲ ثانیه برای یک سیکل کامل).  
     * قرائت سنسور VL53L0X؛ اگر فاصله مثلاً از1.5 میلی‌متر بیشتر یا کمتر از حد مجاز باشد، موتور Y تنظیم می‌شود.  
   * **کنترل گام موتورها**:  
     * دریافت فرمان از رزبری‌پای: مثلاً «چرخش لوله تا زاویه X»، «تنظیم سرعت موتور فیلرY»، و غیره.  
     * تولید پالس‌های دقیق برای موتورهای استپر (R, X, Y, F).

   * **بازخورد (Feedback)**:  
     * موقعیت فعلی موتور ,Y, X، زاویه محور R، و سرعت F را به رزبری‌پای گزارش می‌دهد.

   * **رسیدگی وقفه‌ها**:  
     * انکودر R برای تشخیص گردش لوله.  
     * انکودر X برای تشخیص حرکت و سرعت جوشکاری.  
     * سنسور فاصله برای تصحیح ارتفاع Y.  
     * انکودر Y برای تشخیص حرکت.  
     * انکودر F برای تشخیص تغذیه سیم جوش.  
     * شستی اضطراری و میکروسوئیچ‌ها.

2. **برنامه رزبری‌پای (Python/OpenCV)**

   * **ابتدای کار (Initialization)**:  
     * برقراری ارتباط سریال با آردوینو.  
     * کالیبراسیون دوربین برای تشخیص mm به پیکسل.  
   * **حلقهٔ اصلی نقشه‌برداری و تصمیم‌گیری:**  
     * **چرخش لوله و تصویر‌برداری**  
       * صدور فرمان به آردوینو: «تا زاویه X برو» یا «با سرعت مشخص بچرخ».  
       * پس از پایدار شدن، گرفتن تصویر با دوربین.  
     * **پردازش تصویر (ROI ۵cm×۲cm)**  
       * برش تصویر، تبدیل به خاکستری، آستانه‌گذاری (Threshold)، تشخیص لبه یا تحلیل پیکسل‌ها.  
       * محاسبه عرض شکاف بر حسب میلی‌متر با استفاده از ضریب کالیبراسیون.  
     * **تصمیم‌گیری و نقشه‌برداری**  
       * اگر شکاف \> ۶ میلی‌متر، پروژه رد شود.  
       * در غیر این صورت، شکاف در جدول/آرایه‌ای ثبت می‌شود (Gap Map).  
   * **حلقهٔ اصلی جوشکاری:**  
     * **کنترل سرعت فیلر**  
       * براساس شکاف، سرعت فیلر تنظیم می‌شود (عادی یا سریع).  
     * **گردش ۳۶۰ درجه R**  
       * با انکودر محور R، زوایای ۰ تا ۳۶۰ درجه را پیمایش می‌کنیم.  
   * **رابط کاربری (UI) و گزارش**  
     * نمایش زاویه، شکاف، سرعت فیلر، و خطاها.  
     * ذخیرهٔ لاگ نهایی (زاویه-شکاف-سرعت).

3. **پایان کار (Shutdown)**

   * توقف چرخش لوله، توقف موتور فیلر، خاموش کردن لیزر، بازگشت محورهای X و Y به خانه (Home).  
   * نگهداری و بایگانی داده‌های لاگ.

---

## **منطق توالی رفتار سیستم (Behavior Logic)**

1. **راه‌اندازی (Startup)**

   * کاربر لوله‌ها را در نگهدارنده قرار می‌دهد.  
   * فعال کردن لیزر راهنما برای تراز اولیه.  
   * آردوینو محور R را به مبدأ (۰ درجه طبق انکودر) تنظیم می‌کند.  
   * شکاف در جدول/آرایه‌ای ثبت می‌شود (Gap Map).  
   * توقف در صورت Reject شدن کار

2. **عملیات اصلی جوشکاری Welding**

   * **حرکت X**:  
     * از خانه (۰) تا مرکز مثلاً ۱۰۰۰ گام.  
     * انجام حرکت رفت‌وبرگشتی ±۴۰۰ گام با سرعت تنظیم‌شده (مثلاً ۲ ثانیه برای یک سیکل کامل).  
   * **تنظیم ارتفاع Y**:  
     * شروع از پوزیشن اولیه (مثلاً ۵۰۰ گام).  
     * قرائت سنسور VL53L0X؛ اگر فاصله از1.5 میلی‌متر بیشتر یا کمتر از حد مجاز باشد، موتور Y تنظیم می‌شود.  
   * **تغذیه سیم (F)**:  
     * فید پیوسته با سرعت پایه؛ اگر شکاف زیاد شود (اما هنوز ≤۶ میلی‌متر)، سرعت افزایش می‌یابد.  
   * **چرخاندن لوله (R)** با سرعت حدود ۱ دور در دقیقه (یا هر مقدار تعیین‌شده).  
   * **بینایی و بررسی شکاف**:  
     * در زوایای مختلف (با تکیه بر انکودر)، تصویربرداری و تحلیل.  
     * اگر در بخشی شکاف \> ۶ میلی‌متر شد، کار متوقف یا اخطار داده می‌شود.  
   * **هماهنگی و همگام‌سازی**:  
     * حرکت X، تنظیم Y، و چرخش R تا تکمیل ۳۶۰ درجه یا پایان.

3. **خاموشی و بازگشت (Shutdown)**

   * قطع فید سیم، توقف موتور R (برگشت به ۰ درجه).  
   * خاموش کردن لیزر.  
   * بازگشت محورهای X و Y به خانه.  
   * ذخیرهٔ همهٔ داده‌ها و اعلام اتمام کار.

